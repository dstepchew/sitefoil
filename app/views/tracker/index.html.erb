'use strict';
console.log("sitefoil tracker.js script started, site_id: "+<%= @site.id rescue 'not defined' %>)

function sitefoil_save_visitor_data() {
	var hit_id = "<%= @hit.id %>"


	var xhr = new XMLHttpRequest()
	var url = "http://<%= request.host_with_port%>/tracker/data_from_script?hit_id="+hit_id+
	          "&hit[referrer]="+encodeURIComponent(document.referrer)
	xhr.open('GET', url);
	xhr.onreadystatechange = function (data) {
	  if(xhr.readyState==4) {
	    console.log(xhr.responseText)
	  }
	}
	xhr.send();
}

sitefoil_save_visitor_data()

var sitefoil_visitor = JSON.parse('<%= @hit.to_json.html_safe %>')

function sitefoil_on_load() {

  var visitor = sitefoil_visitor;
  
  <% if @site %>  
	  //running recipes
	  <% @site.recipes.each do |recipe| %>
	    <%= recipe.js.html_safe %>
	  <% end %>
	<% else %>
	  // SITE NOT DEFINED!
	<% end %>

}

window.addEventListener("load", sitefoil_on_load, false); 